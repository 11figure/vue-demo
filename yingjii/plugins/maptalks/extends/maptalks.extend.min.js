(function(){var d;d="undefined"!==typeof module&&module.exports?require("maptalks"):window.maptalks;d.FeatureLayer=d.VectorLayer.extend({breakClassRender:!1,selected:!1,initialize:function(a,c,b){var e=b||{};this.setId(a);this.breakClassRender=this.breakClassRender||e.breakClassRender;this.selected=this.selected||e.selected;this.query=this.query||e.query;this.displayField=this.displayField||e.displayField;this.outputLayerName=this.outputLayerName||e.layerName;d.Util.setOptions(this,b);this._postDataFrom(c)},
    addGeometry:function(a){for(var c=0,b=a.length;c<=b;c++)if(!a[c]instanceof d.Geometry)throw Error("Only a geometry can be added into a Layer");1==this.breakClassRender&&this._breakRenderLayer(this.breakClasses,a);this.fire("loadend",{geometries:a});return d.VectorLayer.prototype.addGeometry.apply(this,arguments)},setRenderProperty:function(a){this.renderAtrribute=a;this.breakClassRender=!0},setBreakRender:function(a){this.breakClasses=this.breakClasses||[];a.length?a instanceof Array&&(this.breakClasses=
            this.breakClasses.concat(a)):this.breakClasses.push(a)},_breakRenderLayer:function(a,c){if(!a)throw Error("you need set render field and set rendered classes!");if(a.length){if(!this.layerData)throw Error("layer data not exist!");if(a instanceof Array){for(var b=c.length,e=this,d=0;d<b;d++)this.layerData.features[d].attributes[this.renderAtrribute]=1E5*Math.random();a.forEach(function(a){for(var d=0;d<b;d++){var f=e.layerData.features[d],l=e._getGeometry(c,f.attributes.OBJECTID),f=parseInt(f.attributes[e.renderAtrribute]);
        f>=a.minValue&&f<a.maxValue&&l.setSymbol(a.renderSymbol)}})}}else this.setBreakRender(a)},_getGeometry:function(a,c){if(a.length)for(var b=0;b<a.length;b++)if(a[b].getId()===c)return a[b]},_postDataFrom_:function(a){this.dataUrl=a;var c=this;d.Ajax.post({url:"../proxy/proxy.ashx"},"url="+encodeURIComponent(a)+"&filter="+encodeURIComponent("/query?objectIds=&where=1%3D1&time=&geometry=&geometryType=esriGeometryEnvelope&inSR=&spatialRel=esriSpatialRelIntersects&relationParam=&outFields=*&returnGeometry=true&maxAllowableOffset=&geometryPrecision=&outSR=&gdbVersion=&returnDistinctValues=false&returnIdsOnly=false&returnCountOnly=false&orderByFields=&groupByFieldsForStatistics=&outStatistics=&returnZ=false&returnM=false&f=pjson"),
        function(b,e){if(!b){var f=d.Util.parseJSON(e);console.log(f.features.length);d.Ajax.post({url:"../proxy/proxy.ashx"},"url="+encodeURIComponent(a)+"&filter="+encodeURIComponent("?f=pjson"),function(a,b){var e=d.Util.parseJSON(b),e=c._addData({data:f,info:e});c.addGeometry(e)})}})},_postDataFrom:function(){var a=this;$.ajax({url:"../test_data/wuhan.min.js",type:"GET",success:function(c){c=a._addData({data:c,info:{geometryType:"esriGeometryPolyline",drawingInfo:{renderer:{symbol:null}}}});a.addGeometry(c)},
        error:function(){}})},_addData:function(a){var c=null;if(a instanceof Object){if(!a.info)throw Error("The layer's geometry type is unknown");switch(a.info.geometryType){case "esriGeometryPoint":c=this._processMarkers(a);break;case "esriGeometryPolygon":c=this._processPolygons(a);break;case "esriGeometryPolyline":c=this._processPolylines(a)}return c}},_processMarkers:function(a){this.layerData=a.data;var c=a.data.features,b=[],e=c.length;console.log(e);for(var f=0;f<e;f++){var h=c[f],g;if(h.attributes.PSNAME){if(g=
            this._getPicMarkerSymbol(h.attributes.PSNAME,a.info.drawingInfo.renderer.uniqueValueInfos),!g)continue}else g=this._parseEsriSymbol(a.info.drawingInfo.renderer.symbol||a.info.drawingInfo.renderer.defaultSymbol);g=new d.Marker([h.geometry.x,h.geometry.y],{symbol:g});1==this.query&&this._setInfoWindow(g,h.attributes);g.attributes=h.attributes;g.setId(h.attributes.OBJECTID);b.push(g)}return b},_startBreakRenderLayer:function(){if(this.layerData&&this._examField(this.layerData.fields,this.renderAtrribute))this._breakRenderLayer(this.breakClassRender);
    else throw Error("attribute you set not exist in featurelayer's fields");},_processPolygons:function(a){this.layerData=a.data;var c=a.data.features;a=this._parseEsriSymbol(a.info.drawingInfo.renderer.symbol);for(var b=[],e=c.length,f=0;f<e;f++){var h=c[f];if(h.geometry){var g=new d.Polygon(h.geometry.rings,{symbol:a});g.attributes=h.attributes;if(1==this.selected){var k=0;g.on("mouseover",function(a){a=a.target;var c=a.getSymbol().polygonOpacity;k=k<c&&0!=k?k:c;c=1>=c+.2?c+.2:1;a.getSymbol();a.updateSymbol({polygonOpacity:c});
        a.on("mouseout",function(a){a.target.updateSymbol({polygonOpacity:k})})})}1==this.query&&this._setInfoWindow(g);g.setId(h.attributes.OBJECTID);b.push(g)}else console.log("this feature has no geometry\uff1a"+f)}return b},_processPolylines:function(a){this.layerData=a.data;a=a.data.features;var c={lineColor:"#f00",lineWidth:2,lineOpacity:0},b=[];if(a)var e=a.length;for(var f=0;f<e;f++){var h=a[f],g=new d.MultiLineString(h.geometry.paths,{symbol:c});1==this.query&&this._setInfoWindow(g,h.attributes);
        g.attributes=h.attributes;g.setId(h.attributes.OBJECTID);b.push(g)}return b},_examField:function(a,c){if(a instanceof Array&&c){for(var b=0;b<a.length;b++)if(a[b].name==c)return!0;return!1}throw Error("attribute you set not in featurelayer's fields");},_parseEsriSymbol:function(a){if(a){if("esriSMS"==a.type)return a={markerType:"ellipse",markerLineColor:"rgb("+a.outline.color[0]+","+a.outline.color[1]+","+a.outline.color[2]+")",lineWidth:a.outline.width,markerLineOpacity:1,markerFill:"rgb("+a.color[0]+
    ","+a.color[1]+","+a.color[2]+")",markerFillOpacity:1,markerWidth:a.size+1,markerHeight:a.size+1};if("esriSFS"==a.type)return a={lineColor:"#1E90FF",lineWidth:3,lineOpacity:1,polygonFill:"rgba(0,0,0,0)",polygonOpacity:1}}},_georeference:function(a){if(a instanceof Array&&0<a.length)for(var c=0;c<a.length;c++)for(var b=a[c],e=0;e<b.length;e++)b[e][0]=Number(b[e][0])+.01235,b[e][1]+=.00235;return a},_getPicMarkerSymbol:function(a,c){if(a&&c)for(var b=c.length,e=0;e<b;e++){var d=c[e];if(d.value==a)return{markerFile:this.dataUrl+
    "/images/"+d.symbol.url,markerWidth:d.symbol.width,markerHeight:d.symbol.height}}},setInfoWin:function(a){this.getGeometries().forEach(function(c){var b=c.attributes,e='<table cellspacing="5" class="gd_table" id="infoWin" style="font-family:"Microsoft YaHei";font-size:10px;">',d;for(d in b)a[d]&&(e+='<tr><td class="gd_table_td">'+a[d]+"</td><td>\uff1a"+b[d]+"</td></tr>");this._setInfoWindow(c,{title:"\u5c5e\u6027\u4fe1\u606f",content:e+"</table>",width:370})}.bind(this))},_setInfoOption:function(a){a=
        a.attributes;var c='<table cellspacing="5" id="infoWin" style="color:black;font-family:"Microsoft YaHei";font-size:10px;">',b;for(b in a)a[b]&&""!=a[b]&&0!=a[b]&&(c+="<tr><td>"+b+"</td><td>\uff1a"+a[b]+"</td></tr>");return{title:"\u5c5e\u6027\u4fe1\u606f",content:c+"</table>"}},_setInfoWindow:function(a,c){var b=c||this._setInfoOption(a),e=(new d.ui.InfoWindow(b)).addTo(a);a.on("click",function(a){e.isVisible()?e.hide():e.show(a.target.getCenter())})},_addLabel:function(a){var c=[];a.forEach(function(a){a.label&&
    c.push(a.label)});return c},_getLayerIndex:function(a,c){for(var b=0;b<c.length;b++)if(a==c[b].name)return c[b].id}});d.FeatureLayer.registerRenderer("canvas",d.renderer.vectorlayer.Canvas)})();
(function(){var d;d="undefined"!==typeof module&&module.exports?require("maptalks"):window.maptalks;d.CanvasdrawLayer=d.Layer.extend({options:{},initialize:function(a,b){this.setId(a);d.Util.setOptions(this,b);this.drawCanvas=null;this.Draw=function(a){this.drawCanvas=a}}});var a=d.renderer.Canvas.extend({initialize:function(a){this.layer=a},draw:function(){this.prepareCanvas();this.layer.drawCanvas&&this.layer.drawCanvas.apply(this,arguments)}});d.CanvasdrawLayer.registerRenderer("canvas",a)})();
(function(){var d,a="undefined"!==typeof module&&module.exports;d=a?require("maptalks"):window.maptalks;d.E3Layer=d.Layer.extend({options:{renderer:"dom"},initialize:function(a,b,e){this.setId(a);this._ecOption=b;d.Util.setOptions(this,e)},getEChartsOption:function(){return this._ecOption},getEc:function(){return this._renderer._ec},setEChartsOption:function(a){this._ecOption=a;this._getRenderer()&&this._getRenderer()._clearAndRedraw();return this}});d.renderer.e3layer={};d.renderer.e3layer.Dom=d.Class.extend({initialize:function(a){this.layer=
    a},render:function(){var a=this.layer;this._container||(this._createLayerContainer(),this._ec=echarts.init(this._container),this._prepareECharts());this._ec.setOption(a._ecOption,!1);this.layer.fire("layerload")},getMap:function(){return this.layer.getMap()},show:function(){this._container&&(this._clearAndRedraw(),this._container.style.display="")},hide:function(){this._container&&(this._container.style.display="none",this.clear())},remove:function(){this._ec.clear();this._ec.dispose();delete this._ec;
    this._removeLayerContainer()},clear:function(){this._ec.clear()},setZIndex:function(a){this._zIndex=a;this._container&&(this._container.style.zIndex=a)},isCanvasRender:function(){return!1},_prepareECharts:function(){this._registered||(echarts.registerCoordinateSystem("maptalks",this._getE3CoordinateSystem(this.getMap())),this._registered=!0);var a=this.layer._ecOption.series;if(a)for(var b=a.length-1;0<=b;b--)a[b].coordinateSystem="maptalks",a[b].animation=!1},_createLayerContainer:function(){this.getMap().getSize();
    var a=this._container=d.DomUtil.createEl("div","maptalks-layer");a.style.cssText="position:absolute;left:0px;top:0px;";this._zIndex&&(a.style.zIndex=this._zIndex);this._resetContainer();this.getMap()._panels.frontLayer.appendChild(a)},_removeLayerContainer:function(){this._container&&d.DomUtil.removeDomNode(this._container);delete this._levelContainers},_resetContainer:function(){var a=this.getMap().offsetPlatform(),b=this.getMap().getSize();d.DomUtil.offsetDom(this._container,a.multi(-1));this._container.style.width=
    b.width+"px";this._container.style.height=b.height+"px"},_getE3CoordinateSystem:function(a){var b=function(a){this.map=a;this._mapOffset=[0,0]};b.create=function(e,d){e.eachSeries(function(e){"maptalks"===e.get("coordinateSystem")&&(e.coordinateSystem=new b(a))})};d.Util.extend(b.prototype,{dimensions:["x","y"],setMapOffset:function(a){this._mapOffset=a},dataToPoint:function(a){a=new d.Coordinate(a);a=this.map.coordinateToContainerPoint(a);var b=this._mapOffset;return[a.x-b[0],a.y-b[1]]},pointToData:function(a){var b=
    this._mapOffset;a=this._bmap.containerPointToCoordinate({x:a[0]+b[0],y:a[1]+b[1]});return[a.x,a.y]},getViewRect:function(){var a=this.map.getSize();return new echarts.graphic.BoundingRect(0,0,a.width,a.height)},getRoamTransform:function(){return echarts.matrix.create()}});return b},getEvents:function(){return{_zoomstart:this.onZoomStart,_zoomend:this.onZoomEnd,_moveend:this.onMoveEnd,_resize:this._clearAndRedraw}},onMoveEnd:function(){this.layer.isVisible()&&(this._resetContainer(),this._ec.resize())},
    _clearAndRedraw:function(){this.layer.isVisible()&&(this._ec.clear(),this._resetContainer(),this._ec.resize(),this.render())},onZoomStart:function(){this.layer.isVisible()&&this.hide()},onZoomEnd:function(){this.layer.isVisible()&&this.show()}});d.E3Layer.registerRenderer("dom",d.renderer.e3layer.Dom);a&&(module.exports=d.E3Layer)})();